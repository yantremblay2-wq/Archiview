<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Grid Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .game-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 500px; /* Adjusted max-width for 5x5 grid */
            text-align: center;
            position: relative;
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 1.5rem auto;
            border: 2px solid #cbd5e0;
            border-radius: 12px;
            padding: 8px;
        }
        .grid-cell {
            width: 100%;
            padding-top: 100%;
            position: relative;
            background-color: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .grid-cell-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .grid-cell:hover:not(.occupied) {
            background-color: #e2e8f0;
        }
        .occupied {
            cursor: not-allowed;
        }
        .occupied.player-1 {
            background-color: #f7fafc;
            color: #2d3748;
        }
        .occupied.player-2 {
            background-color: #2d3748;
            color: #ffffff;
        }
        .player-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .player-card {
            background-color: #e2e8f0;
            padding: 1rem;
            border-radius: 12px;
            width: 45%;
            min-width: 150px;
            margin-top: 1rem;
        }
        .player-card.active {
            box-shadow: 0 0 0 3px #63b3ed;
            background-color: #ebf8ff;
        }
        .number-selector {
            display: none;
        }
        .number-btn {
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #63b3ed;
            color: white;
        }
        .number-btn[disabled] {
            background-color: #a0aec0;
            cursor: not-allowed;
            transform: scale(1);
        }
        #message-box {
            background-color: #fff;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 700;
            margin-top: 1rem;
        }
        .control-btn {
            background-color: #e2e8f0;
            color: #4a5568;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }
        .popup {
            position: fixed;
            background-color: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: flex;
            gap: 0.5rem;
            flex-direction: column-reverse;
            display: none;
        }
        .popup-visible {
            display: flex;
        }
        #timer-display {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="timer-display">00:00</div>
        <p id="status" class="text-xl font-semibold mb-4 text-gray-700"></p>

        <div class="player-info">
            <div id="player-1-card" class="player-card active">
                <h3 class="text-lg font-bold">White</h3>
                <p>1s: <span id="p1-1s"></span> | 2s: <span id="p1-2s"></span> | 3s: <span id="p1-3s"></span></p>
                <p>Score: <span id="p1-score">0</span></p>
            </div>
            <div id="player-2-card" class="player-card">
                <h3 class="text-lg font-bold">Black</h3>
                <p>1s: <span id="p2-1s"></span> | 2s: <span id="p2-2s"></span> | 3s: <span id="p2-3s"></span></p>
                <p>Score: <span id="p2-score">0</span></p>
            </div>
        </div>

        <div id="number-popup" class="popup">
            <button class="number-btn" data-value="1">1</button>
            <button class="number-btn" data-value="2">2</button>
            <button class="number-btn" data-value="3">3</button>
        </div>

        <div id="game-grid" class="game-grid"></div>
        
        <div id="message-box" class="hidden"></div>
        
        <div class="flex justify-center gap-4 mt-4">
            <button id="undo-btn" class="control-btn">Undo</button>
            <div id="total-score-card" class="player-card">
                <h3 class="text-lg font-bold">Total Score</h3>
                <p id="total-score">0</p>
            </div>
            <button id="reset-btn" class="control-btn">Reset</button>
            <button id="toggle-size-btn" class="control-btn">Switch to 7x7</button>
        </div>
    </div>

    <script>
        // Game state variables
        let currentPlayer = 1;
        let selectedCellIndex = null;
        let gridSize = 5;
        let board = Array(gridSize * gridSize).fill(null);
        let history = [];
        let players = {
            1: {
                numbers: { '1': 4, '2': 4, '3': 4 },
                score: 0
            },
            2: {
                numbers: { '1': 4, '2': 4, '3': 4 },
                score: 0
            }
        };
        const playerNames = { 1: 'White', 2: 'Black' };

        // Timer variables
        let timerInterval = null;
        let startTime = null;
        let isFirstMove = true;

        // DOM elements
        const statusEl = document.getElementById('status');
        const gridEl = document.getElementById('game-grid');
        const numberPopup = document.getElementById('number-popup');
        const popupButtons = numberPopup.querySelectorAll('.number-btn');
        const undoBtn = document.getElementById('undo-btn');
        const resetBtn = document.getElementById('reset-btn');
        const toggleSizeBtn = document.getElementById('toggle-size-btn');
        const player1Card = document.getElementById('player-1-card');
        const player2Card = document.getElementById('player-2-card');
        const messageBox = document.getElementById('message-box');
        const timerDisplay = document.getElementById('timer-display');

        // Initial rendering on page load
        window.onload = function() {
            renderGrid();
            updateUI();
            
            // Set initial timer display to 00:00
            timerDisplay.textContent = '00:00';

            popupButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.dataset.value;
                    if (selectedCellIndex !== null && !button.disabled) {
                        placeNumber(value, selectedCellIndex);
                        hideNumberPopup();
                    }
                });
            });

            undoBtn.addEventListener('click', undo);
            resetBtn.addEventListener('click', resetGame);
            toggleSizeBtn.addEventListener('click', toggleGridSize);

            document.addEventListener('click', (event) => {
                if (!numberPopup.contains(event.target) && !gridEl.contains(event.target)) {
                    hideNumberPopup();
                }
            });
        };

        // Functions
        function renderGrid() {
            gridEl.innerHTML = '';
            gridEl.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            
            for (let i = 0; i < gridSize * gridSize; i++) {
                const cell = document.createElement('div');
                cell.classList.add('grid-cell');
                cell.dataset.index = i;
                
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('grid-cell-content');
                cell.appendChild(contentDiv);
                
                if (board[i] !== null) {
                    cell.classList.add('occupied', `player-${board[i].player}`);
                    contentDiv.textContent = board[i].value;
                } else {
                    cell.addEventListener('click', showNumberPopup);
                }
                gridEl.appendChild(cell);
            }
        }

        function startTimer() {
            stopTimer(); // Clear any existing timer
            startTime = Date.now();
            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay(); // Initial display
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            if (startTime) {
                const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                timerDisplay.textContent = formattedTime;
            }
        }
        
        function showNumberPopup(event) {
            const cell = event.target.closest('.grid-cell');
            if (board[cell.dataset.index] !== null) {
                return;
            }

            event.stopPropagation();
            selectedCellIndex = parseInt(cell.dataset.index);
            
            popupButtons.forEach(button => {
                const value = button.dataset.value;
                button.disabled = players[currentPlayer].numbers[value] <= 0;
            });

            numberPopup.classList.add('popup-visible');

            const cellRect = cell.getBoundingClientRect();
            const popupRect = numberPopup.getBoundingClientRect();
            
            let popupLeft = cellRect.left + cellRect.width / 2;
            let popupTop = cellRect.top + cellRect.height / 2 - popupRect.height / 2;
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            if (popupLeft < 0) {
                popupLeft = 0;
            } else if (popupLeft + popupRect.width > viewportWidth) {
                popupLeft = viewportWidth - popupRect.width;
            }

            if (popupTop < 0) {
                popupTop = 0;
            } else if (popupTop + popupRect.height > viewportHeight) {
                popupTop = viewportHeight - popupRect.height;
            }
            
            numberPopup.style.left = `${popupLeft}px`;
            numberPopup.style.top = `${popupTop}px`;
        }

        function hideNumberPopup() {
            numberPopup.classList.remove('popup-visible');
            selectedCellIndex = null;
        }

        function placeNumber(value, index) {
            if (isFirstMove) {
                startTimer();
                isFirstMove = false;
            }

            history.push({ 
                board: JSON.parse(JSON.stringify(board)), 
                players: JSON.parse(JSON.stringify(players)), 
                currentPlayer: currentPlayer 
            });

            board[index] = { value: parseInt(value), player: currentPlayer };
            players[currentPlayer].numbers[value]--;

            calculateScores();

            currentPlayer = currentPlayer === 1 ? 2 : 1;
            selectedCellIndex = null;
            
            renderGrid();
            updateUI();
            checkGameOver();
        }

        function updateUI() {
            statusEl.textContent = `${playerNames[currentPlayer]}'s turn`;
            document.getElementById(`p1-1s`).textContent = players[1].numbers['1'];
            document.getElementById(`p1-2s`).textContent = players[1].numbers['2'];
            document.getElementById(`p1-3s`).textContent = players[1].numbers['3'];
            document.getElementById(`p2-1s`).textContent = players[2].numbers['1'];
            document.getElementById(`p2-2s`).textContent = players[2].numbers['2'];
            document.getElementById(`p2-3s`).textContent = players[2].numbers['3'];
            document.getElementById(`p1-score`).textContent = players[1].score;
            document.getElementById(`p2-score`).textContent = players[2].score;
            document.getElementById('total-score').textContent = players[1].score + players[2].score;

            if (currentPlayer === 1) {
                player1Card.classList.add('active');
                player2Card.classList.remove('active');
            } else {
                player2Card.classList.add('active');
                player1Card.classList.remove('active');
            }
        }
        
        function resetGame() {
            currentPlayer = 1;
            selectedCellIndex = null;
            board = Array(gridSize * gridSize).fill(null);
            history = [];

            // Adjusted numbers based on grid size
            if (gridSize === 7) {
                players = {
                    1: { numbers: { '1': 8, '2': 8, '3': 8 }, score: 0 },
                    2: { numbers: { '1': 8, '2': 8, '3': 8 }, score: 0 }
                };
            } else {
                players = {
                    1: { numbers: { '1': 4, '2': 4, '3': 4 }, score: 0 },
                    2: { numbers: { '1': 4, '2': 4, '3': 4 }, score: 0 }
                };
            }
            
            renderGrid();
            updateUI();
            stopTimer(); // Stop the timer when the game is reset
            isFirstMove = true; // Reset the flag
            timerDisplay.textContent = '00:00'; // Reset timer display
            showMessage("Game has been reset.");
        }

        function toggleGridSize() {
            gridSize = (gridSize === 5) ? 7 : 5;
            toggleSizeBtn.textContent = `Switch to ${gridSize === 5 ? '7x7' : '5x5'}`;
            resetGame();
        }

        function calculateScores() {
            players[1].score = 0;
            players[2].score = 0;

            for (let i = 0; i < gridSize * gridSize; i++) {
                const cell = board[i];
                if (cell !== null) {
                    const row = Math.floor(i / gridSize);
                    const col = i % gridSize;
                    let tileScore = 0;

                    const neighbors = [
                        { r: row - 1, c: col },
                        { r: row + 1, c: col },
                        { r: row, c: col - 1 },
                        { r: row, c: col + 1 }
                    ];

                    neighbors.forEach(neighbor => {
                        if (neighbor.r >= 0 && neighbor.r < gridSize && neighbor.c >= 0 && neighbor.c < gridSize) {
                            const neighborIndex = neighbor.r * gridSize + neighbor.c;
                            const neighborValue = board[neighborIndex] ? board[neighborIndex].value : 0;
                            tileScore += Math.max(0, cell.value - neighborValue);
                        } else {
                            tileScore += Math.max(0, cell.value - 0);
                        }
                    });

                    players[cell.player].score += tileScore;
                }
            }
        }

        function undo() {
            if (history.length > 0) {
                const lastState = history.pop();
                board = lastState.board;
                players = lastState.players;
                currentPlayer = lastState.currentPlayer;
                selectedCellIndex = null;
                renderGrid();
                updateUI();
                showMessage("Move undone.");
            } else {
                showMessage("Cannot undo further.");
            }
        }

        function checkGameOver() {
            const occupiedCells = board.filter(cell => cell !== null).length;
            if (occupiedCells === (gridSize * gridSize)) {
                stopTimer();
                const p1Score = players[1].score;
                const p2Score = players[2].score;
                const finalTime = timerDisplay.textContent;
                let winnerMessage = "";
                if (p1Score > p2Score) {
                    winnerMessage = `Game Over! White wins with a score of ${p1Score}! Final time: ${finalTime}.`;
                } else if (p2Score > p1Score) {
                    winnerMessage = `Game Over! Black wins with a score of ${p2Score}! Final time: ${finalTime}.`;
                } else {
                    winnerMessage = `Game Over! It's a tie with a score of ${p1Score}! Final time: ${finalTime}.`;
                }
                showMessage(winnerMessage);
            }
        }
        
        function showMessage(text) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
